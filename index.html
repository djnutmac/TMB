<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TMB Barcelona - Bus & Percorsi</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #f5f5f5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .gradient-red {
            background: linear-gradient(135deg, #dc0530 0%, #ff1744 100%);
        }
        
        .bus-badge {
            min-width: 52px;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 700;
            text-align: center;
            color: white;
            font-size: 1.1rem;
            letter-spacing: -0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        @media (min-width: 640px) {
            .bus-badge {
                min-width: 65px;
                padding: 10px 14px;
                font-size: 1.3rem;
            }
        }
        
        .line-normal { background: linear-gradient(135deg, #dc0530 0%, #ff1744 100%); }
        .line-v { background: linear-gradient(135deg, #00a651 0%, #00c853 100%); }
        /* COLORE H FORZATO A BLU SCURO */
        .line-h { background: linear-gradient(135deg, #003888 0%, #004bad 100%); }
        .line-d { background: linear-gradient(135deg, #8e44ad 0%, #ab47bc 100%); }
        .line-x { background: linear-gradient(135deg, #1a1a1a 0%, #424242 100%); }
        
        .time-display {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        @media (min-width: 640px) {
            .time-display {
                font-size: 1.3rem;
            }
        }
        
        .time-red { color: #dc0530; }
        .time-green { 
            color: #00c853;
            animation: pulse-green 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .tab-btn {
            position: relative;
            padding: 10px 6px;
            font-weight: 600;
            font-size: 0.7rem;
            color: #999;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            flex: 1;
            white-space: nowrap;
        }
        
        @media (min-width: 640px) {
            .tab-btn {
                padding: 14px 20px;
                font-size: 0.85rem;
            }
        }
        
        .tab-btn.active {
            color: #dc0530;
            background: white;
            border-radius: 12px 12px 0 0;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: #dc0530;
            border-radius: 3px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .card-bus {
            background: #fafafa;
            border: 1px solid #eee;
        }
        
        .input-modern {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 14px;
            color: #333;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .input-modern:focus {
            outline: none;
            border-color: #dc0530;
            background: white;
            box-shadow: 0 0 0 3px rgba(220,5,48,0.1);
        }
        
        .input-modern::placeholder {
            color: #999;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #dc0530 0%, #ff1744 100%);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(220,5,48,0.3);
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(220,5,48,0.4);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #0066b3 0%, #2196f3 100%);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,102,179,0.3);
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .btn-secondary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,102,179,0.4);
        }
        
        .btn-secondary:active {
            transform: scale(0.98);
        }
        
        .star-btn {
            font-size: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            background: none;
            border: none;
            padding: 4px;
        }
        
        .star-btn.active {
            color: #ffc107;
            text-shadow: 0 0 10px rgba(255,193,7,0.5);
        }
        
        .star-btn:not(.active) {
            color: #ccc;
        }
        
        .map-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #e3f2fd;
            color: #1976d2;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .map-btn:hover {
            background: #1976d2;
            color: white;
            transform: scale(1.1);
        }
        
        .map-btn:active {
            transform: scale(0.95);
        }
        
        .connection-chip {
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        .metro-l1 { background: #e2241a; color: white; }
        .metro-l2 { background: #9b3a98; color: white; }
        .metro-l3 { background: #37aa4d; color: white; }
        .metro-l4 { background: #f7b725; color: black; }
        .metro-l5 { background: #0066b3; color: white; }
        .tram { background: #00a651; color: white; }
        
        /* MAPPA QUADRATA */
        #map { 
            width: 100%; 
            aspect-ratio: 1 / 1;
            height: auto;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .stop-item {
            padding: 12px 14px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .stop-item:hover {
            background: rgba(220,5,48,0.05);
        }
        
        .stop-item:last-child {
            border-bottom: none;
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 4px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 2px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #eee;
            border-top-color: #dc0530;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .favorite-chip {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            color: #333;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .favorite-chip:hover {
            background: #f5f5f5;
            border-color: #dc0530;
        }
        
        .header-time {
            font-size: 1.5rem;
            line-height: 1.2;
        }
        
        @media (min-width: 640px) {
            .header-time {
                font-size: 2.2rem;
            }
        }
        
        .main-container {
            padding: 8px;
            max-width: 1024px; /* ALLARGATO PER DESKTOP */
            margin: 0 auto;
        }
        
        @media (min-width: 640px) {
            .main-container {
                padding: 16px;
            }
        }
        
        .search-container {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }
        
        .search-input-wrapper {
            flex: 1;
            min-width: 0;
        }
        
        .search-btn {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            padding: 0;
        }
        
        .content-padding {
            padding: 12px;
        }
        
        @media (min-width: 640px) {
            .content-padding {
                padding: 20px;
            }
        }
        
        .bus-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .bus-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        
        .bus-destination {
            flex: 1;
            min-width: 0;
        }
        
        .bus-destination p {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .leaflet-tooltip {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .nearby-stop {
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nearby-stop:hover {
            border-color: #dc0530;
            box-shadow: 0 2px 8px rgba(220,5,48,0.1);
        }
        
        .distance-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .location-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 44px;
            height: 44px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }
        
        .location-btn:hover {
            border-color: #0066b3;
            background: #e3f2fd;
        }
        
        .location-btn.active {
            border-color: #0066b3;
            background: #0066b3;
            color: white;
        }
        
        .user-marker {
            width: 20px;
            height: 20px;
            background: #0066b3;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,102,179,0.5);
        }
        
        .user-marker-pulse {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(0,102,179,0.2);
            border-radius: 50%;
            animation: pulse-location 2s ease-out infinite;
        }
        
        @keyframes pulse-location {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Route Styles */
        .route-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .route-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .route-time {
            font-weight: 800;
            font-size: 1.2rem;
            color: #333;
        }
        .route-duration {
            font-size: 0.9rem;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .segment-detail {
            margin-bottom: 12px;
            position: relative;
            padding-left: 20px;
        }
        .segment-detail:last-child {
            margin-bottom: 0;
        }
        .segment-line-left {
            position: absolute;
            left: 5px;
            top: 5px;
            bottom: -15px;
            width: 2px;
            background: #e0e0e0;
        }
        .segment-detail:last-child .segment-line-left {
            display: none;
        }
        .segment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }
        .segment-dot-indicator {
            position: absolute;
            left: 0;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #ddd;
        }
        .segment-walk-info {
            color: #666;
            font-size: 0.9rem;
            font-style: italic;
        }
        .segment-bus-info {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #eee;
        }
        .stop-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        .stop-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #999;
            font-weight: 700;
            margin-bottom: 1px;
        }
        .stop-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }
        .stop-code-pill {
            background: #eee;
            color: #666;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* MAPPA PERCORSO QUADRATA */
        .map-container-route {
            width: 100%;
            aspect-ratio: 1 / 1;
            height: auto;
            border-radius: 8px;
            margin-top: 12px;
            border: 1px solid #ddd;
            z-index: 1;
        }

        /* Autocomplete Styles */
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .suggestion-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
            color: #333;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background: #f9f9f9;
            color: #dc0530;
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <!-- Header -->
        <div class="card p-3 sm:p-4 mb-1 rounded-b-none">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-2 sm:gap-3">
                    <img src="https://www.tmb.cat/documents/20184/96095/logo-tmb-512x512.png" 
                         alt="TMB Logo" 
                         class="h-10 w-10 sm:h-12 sm:w-12 rounded-xl shadow-md flex-shrink-0 object-contain bg-white"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 gradient-red rounded-xl items-center justify-center shadow-md flex-shrink-0 hidden">
                        <span class="text-white font-bold text-xs sm:text-sm">TMB</span>
                    </div>
                    <div>
                        <h1 class="text-base sm:text-xl font-bold text-gray-800 tracking-tight">TMB Barcelona</h1>
                        <p class="text-gray-500 text-xs sm:text-sm">Bus in Tempo Reale</p>
                    </div>
                </div>
                <div class="text-right flex-shrink-0">
                    <div id="currentTime" class="header-time font-bold text-gray-800 tracking-tight"></div>
                    <div id="currentDate" class="text-xs sm:text-sm text-gray-500 mt-0.5"></div>
                </div>
            </div>
        </div>
        
        <!-- Tabs (ORDINE: Cerca - Percorso - Vicinanze - Mappa - Preferiti) -->
        <div class="flex bg-gray-200 rounded-none overflow-x-auto">
            
            <button id="tabCerca" onclick="switchTab('cerca')" class="tab-btn active">
                <span class="flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <span class="hidden sm:inline">Cerca</span>
                </span>
            </button>

            <button id="tabPercorso" onclick="switchTab('percorso')" class="tab-btn">
                <span class="flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span class="hidden sm:inline">Percorso</span>
                </span>
            </button>

            <button id="tabVicinanze" onclick="switchTab('vicinanze')" class="tab-btn">
                <span class="flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="hidden sm:inline">Vicinanze</span>
                </span>
            </button>

            <button id="tabMappa" onclick="switchTab('mappa')" class="tab-btn">
                <span class="flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                    </svg>
                    <span class="hidden sm:inline">Mappa</span>
                </span>
            </button>

            <button id="tabPreferiti" onclick="switchTab('preferiti')" class="tab-btn">
                <span class="flex items-center justify-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                    </svg>
                    <span class="hidden sm:inline">Preferiti</span>
                </span>
            </button>
            
        </div>
        
        <!-- Content -->
        <div class="card rounded-t-none min-h-[400px]">
            
            <!-- Tab Cerca -->
            <div id="contentCerca" class="content-padding">
                <!-- Search Bar -->
                <div class="search-container mb-4">
                    <div class="search-input-wrapper">
                        <input type="text" id="stopCode" placeholder="Codice fermata (es. 108)" 
                               class="input-modern"
                               inputmode="numeric"
                               onkeypress="if(event.key==='Enter')searchStop()">
                    </div>
                    <button onclick="searchStop()" class="btn-primary search-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Quick Favorites -->
                <div id="quickFavorites" class="mb-4 hidden">
                    <p class="text-gray-500 text-xs font-medium mb-2">‚≠ê Accesso Rapido</p>
                    <div id="favoritesButtons" class="flex flex-wrap gap-2"></div>
                </div>
                
                <!-- Stop Info -->
                <div id="stopInfo" class="hidden mb-4 card-bus p-3 sm:p-4 rounded-xl fade-in">
                    <div class="flex items-center justify-between gap-2">
                        <div class="min-w-0 flex-1">
                            <h2 id="stopName" class="text-base sm:text-lg font-bold text-gray-800 truncate"></h2>
                            <div class="flex items-center gap-2">
                                <p id="stopCodeDisplay" class="text-gray-500 text-sm"></p>
                                <span class="text-gray-300">‚Ä¢</span>
                                <p id="lastUpdate" class="text-gray-400 text-xs"></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button onclick="showStopOnMap()" class="map-btn" title="Vedi sulla mappa">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            <button id="favoriteBtn" onclick="toggleFavorite()" class="star-btn flex-shrink-0">‚òÜ</button>
                        </div>
                    </div>
                </div>
                
                <!-- Results -->
                <div id="results" class="space-y-2"></div>
                
                <!-- Connections -->
                <div id="connections" class="hidden mt-4 card-bus p-3 sm:p-4 rounded-xl fade-in">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                        </svg>
                        Connessioni
                    </h3>
                    <div id="connectionsList" class="flex flex-wrap gap-2"></div>
                </div>
                
                <!-- Loading -->
                <div id="loading" class="hidden py-10 flex flex-col items-center">
                    <div class="loading-spinner"></div>
                    <p class="mt-3 text-gray-500 text-sm">Caricamento...</p>
                </div>
                
                <!-- Error -->
                <div id="error" class="hidden card-bus p-4 text-center rounded-xl">
                    <div class="text-red-500 text-3xl mb-2">‚ö†Ô∏è</div>
                    <p id="errorText" class="text-gray-600 text-sm"></p>
                </div>
            </div>
            
            <!-- Tab Percorso -->
            <div id="contentPercorso" class="content-padding hidden">
                <div class="space-y-4 mb-4">
                    <div class="relative">
                        <label class="block text-xs text-gray-500 mb-1 ml-1 font-semibold">PARTENZA</label>
                        <div class="relative">
                            <input type="text" id="routeFrom" placeholder="Cerca indirizzo o fermata..." 
                                   class="input-modern pr-10" 
                                   oninput="handleAddressInput(this, 'fromList')"
                                   autocomplete="off">
                            <button onclick="useMyLocationForRoute()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 p-2" title="Usa la mia posizione">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                        </div>
                        <div id="fromList" class="suggestions-list"></div>
                    </div>
                    
                    <div class="relative">
                        <label class="block text-xs text-gray-500 mb-1 ml-1 font-semibold">DESTINAZIONE</label>
                        <input type="text" id="routeTo" placeholder="Cerca destinazione..." 
                               class="input-modern"
                               oninput="handleAddressInput(this, 'toList')"
                               autocomplete="off">
                        <div id="toList" class="suggestions-list"></div>
                    </div>
                    
                    <button onclick="calculateRoute()" class="btn-primary w-full flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        Calcola Percorso (Bus)
                    </button>
                </div>
                
                <div id="routeLoading" class="hidden py-10 flex flex-col items-center">
                    <div class="loading-spinner"></div>
                    <p class="mt-3 text-gray-500 text-sm">Ricerca percorso migliore...</p>
                </div>
                
                <div id="routeResults" class="space-y-3"></div>
            </div>
            
            <!-- Tab Vicinanze -->
            <div id="contentVicinanze" class="content-padding hidden">
                <div class="mb-4">
                    <button onclick="getMyLocation()" class="btn-secondary w-full flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Trova Fermate Vicine
                    </button>
                </div>
                
                <!-- Location Loading -->
                <div id="locationLoading" class="hidden py-10 flex flex-col items-center">
                    <div class="loading-spinner"></div>
                    <p class="mt-3 text-gray-500 text-sm">Ricerca posizione...</p>
                </div>
                
                <!-- Location Error -->
                <div id="locationError" class="hidden card-bus p-4 text-center rounded-xl">
                    <div class="text-red-500 text-3xl mb-2">üìç</div>
                    <p id="locationErrorText" class="text-gray-600 text-sm"></p>
                </div>
                
                <!-- Nearby Stops List -->
                <div id="nearbyStopsList"></div>
                
                <!-- Initial Message -->
                <div id="nearbyInitial" class="text-center py-10">
                    <div class="text-5xl mb-4">üìç</div>
                    <p class="text-gray-500 text-sm">Clicca il pulsante per trovare<br>le fermate pi√π vicine a te</p>
                </div>
            </div>
            
            <!-- Tab Preferiti -->
            <div id="contentPreferiti" class="content-padding hidden">
                <div class="mb-4">
                    <input type="text" id="searchStops" placeholder="Cerca fermata..." 
                           class="input-modern"
                           oninput="filterStops()">
                </div>
                
                <div class="mb-5">
                    <h3 class="font-bold text-gray-700 mb-2 flex items-center gap-2 text-sm">
                        <span class="text-yellow-500">‚òÖ</span> Le Tue Fermate
                    </h3>
                    <div id="myFavoritesList" class="card-bus rounded-xl max-h-40 overflow-y-auto scrollbar-custom"></div>
                </div>
                
                <div>
                    <h3 class="font-bold text-gray-700 mb-2 flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Tutte le Fermate
                    </h3>
                    <div id="allStopsList" class="card-bus rounded-xl max-h-60 overflow-y-auto scrollbar-custom"></div>
                </div>
            </div>
            
            <!-- Tab Mappa -->
            <div id="contentMappa" class="content-padding hidden">
                <div style="position: relative;">
                    <div id="map" class="mb-4"></div>
                    <button onclick="centerOnMyLocation()" class="location-btn" id="mapLocationBtn" title="La mia posizione">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
                <div id="mapStopInfo" class="hidden fade-in">
                    <div class="card-bus p-3 rounded-xl mb-3">
                        <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0 flex-1">
                                <h3 id="mapStopName" class="font-bold text-sm text-gray-800 truncate"></h3>
                                <p id="mapStopCode" class="text-gray-500 text-xs"></p>
                            </div>
                            <button onclick="viewStopFromMap()" class="btn-primary text-xs px-3 py-2">
                                VISUALIZZA
                            </button>
                        </div>
                    </div>
                    <div id="mapBusResults" class="space-y-2"></div>
                </div>
            </div>
            
        </div>
        
        <!-- Footer -->
        <div class="text-center text-gray-400 text-xs mt-4 pb-3">
            Dati forniti da TMB Barcelona - v2.0
        </div>
    </div>

    <script>
        const API_ID = '16619440';
        const API_KEY = 'e596d48164d007881b182b84bb3099bf';
        const BASE_URL = 'https://api.tmb.cat/v1';
        
        // --- PROXY HELPER WITH ROUND-ROBIN ---
        async function fetchWithProxy(targetUrl) {
            const proxies = [
                {
                    // Strategy 1: AllOrigins (Wrapped JSON) - often reliable
                    url: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&disableCache=true`,
                    extract: (data) => JSON.parse(data.contents)
                },
                {
                    // Strategy 2: CodeTabs - direct proxy
                    url: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
                    extract: (data) => data
                },
                {
                    // Strategy 3: CorsProxy.io - direct proxy
                    url: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                    extract: (data) => data
                }
            ];

            let lastError = null;

            for (const proxy of proxies) {
                try {
                    const response = await fetch(proxy.url(targetUrl));
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    const data = await response.json();
                    const result = proxy.extract(data);
                    return result; // Return immediately on success
                } catch (e) {
                    console.warn(`Proxy failed: ${proxy.url(targetUrl).split('?')[0]}`, e);
                    lastError = e;
                    // Continue to next proxy
                }
            }
            throw lastError || new Error("All proxies failed");
        }

        // --- POLYLINE DECODER ---
        function decodePolyline(str, precision) {
            var index = 0,
                lat = 0,
                lng = 0,
                coordinates = [],
                shift = 0,
                result = 0,
                byte = null,
                latitude_change,
                longitude_change,
                factor = Math.pow(10, precision || 5);

            while (index < str.length) {
                byte = null;
                shift = 0;
                result = 0;

                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
                shift = result = 0;

                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

                lat += latitude_change;
                lng += longitude_change;

                coordinates.push([lat / factor, lng / factor]);
            }

            return coordinates;
        }

        let allStops = [];
        let favorites = JSON.parse(localStorage.getItem('tmbFavorites')) || [];
        let currentStop = null;
        let map = null;
        let markers = [];
        let selectedMapStop = null;
        let autoRefreshInterval = null;
        let lastSearchedCode = null;
        let userLocation = null;
        let userMarker = null;
        
        // Update time
        function updateDateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
            
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('it-IT', timeOptions);
            
            let dateStr = now.toLocaleDateString('it-IT', dateOptions);
            dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            document.getElementById('currentDate').textContent = dateStr;
        }
        
        setInterval(updateDateTime, 1000);
        updateDateTime();
        
        // Tab switching
        function switchTab(tab) {
            // New order: Cerca - Percorso - Vicinanze - Mappa - Preferiti
            const tabs = ['cerca', 'percorso', 'vicinanze', 'mappa', 'preferiti'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                const content = document.getElementById('content' + t.charAt(0).toUpperCase() + t.slice(1));
                
                if (t === tab) {
                    btn.classList.add('active');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('active');
                    content.classList.add('hidden');
                }
            });
            
            if (tab === 'mappa' && !map) {
                setTimeout(initMap, 100);
            }
            if (tab === 'preferiti') {
                renderFavoritesList();
                renderAllStops();
            }
        }
        
        // Get line color class
        function getLineClass(line) {
            const l = line.toUpperCase();
            if (l.startsWith('V')) return 'line-v';
            if (l.startsWith('H')) return 'line-h';
            if (l.startsWith('D')) return 'line-d';
            if (l.startsWith('X')) return 'line-x';
            return 'line-normal';
        }
        
        // Format arrival time
        function formatArrival(minutes) {
            if (minutes <= 0) return '<span class="time-display time-green">Imminente</span>';
            if (minutes === 1) return '<span class="time-display time-red">1 min</span>';
            return `<span class="time-display time-red">${minutes} min</span>`;
        }
        
        // Search stop
        async function searchStop(silentRefresh = false) {
            let code = document.getElementById('stopCode').value.trim();
            
            if (silentRefresh && lastSearchedCode) {
                code = lastSearchedCode;
            }
            
            if (!code) return;
            
            lastSearchedCode = code;
            startAutoRefresh();
            
            if (!silentRefresh) {
                document.getElementById('stopCode').value = '';
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('results').innerHTML = '';
                document.getElementById('error').classList.add('hidden');
                document.getElementById('stopInfo').classList.add('hidden');
                document.getElementById('connections').classList.add('hidden');
            }
            
            try {
                if (!silentRefresh) {
                    const stopData = await fetchWithProxy(`${BASE_URL}/transit/parades/${code}?app_id=${API_ID}&app_key=${API_KEY}`);
                    
                    if (stopData.features && stopData.features.length > 0) {
                        const stop = stopData.features[0].properties;
                        currentStop = { code: code, name: stop.NOM_PARADA || `Fermata ${code}` };
                        
                        document.getElementById('stopName').textContent = currentStop.name;
                        document.getElementById('stopCodeDisplay').textContent = `Codice: ${code}`;
                        document.getElementById('stopInfo').classList.remove('hidden');
                        
                        updateFavoriteButton();
                    }
                }
                
                const data = await fetchWithProxy(`${BASE_URL}/ibus/stops/${code}?app_id=${API_ID}&app_key=${API_KEY}`);
                
                if (!silentRefresh) {
                    document.getElementById('loading').classList.add('hidden');
                }
                
                const now = new Date();
                document.getElementById('lastUpdate').textContent = `Agg. ${now.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit', second: '2-digit'})}`;
                
                if (data.data && data.data.ibus && data.data.ibus.length > 0) {
                    let buses = data.data.ibus
                        .filter(bus => !bus.line.toUpperCase().startsWith('N'))
                        .sort((a, b) => a['t-in-min'] - b['t-in-min']);
                    
                    if (buses.length === 0) {
                        document.getElementById('errorText').textContent = 'Nessun autobus diurno disponibile per questa fermata.';
                        document.getElementById('error').classList.remove('hidden');
                        document.getElementById('results').innerHTML = '';
                        return;
                    }
                    
                    document.getElementById('error').classList.add('hidden');
                    
                    const resultsHtml = buses.map((bus, index) => `
                        <div class="card-bus rounded-xl p-3 sm:p-4 ${silentRefresh ? '' : 'fade-in'}" style="${silentRefresh ? '' : 'animation-delay: ' + (index * 0.03) + 's'}">
                            <div class="bus-row">
                                <div class="bus-info">
                                    <div class="bus-badge ${getLineClass(bus.line)}">${bus.line}</div>
                                    <div class="bus-destination">
                                        <p class="font-semibold text-gray-800 text-sm sm:text-base">${bus.destination || 'Destinazione'}</p>
                                        <p class="text-gray-500 text-xs mt-0.5">${bus['text-ca'] || ''}</p>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    ${formatArrival(bus['t-in-min'])}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('results').innerHTML = resultsHtml;
                    if (!silentRefresh) {
                        showConnections(buses);
                    }
                } else {
                    document.getElementById('errorText').textContent = 'Nessun autobus in arrivo per questa fermata.';
                    document.getElementById('error').classList.remove('hidden');
                    document.getElementById('results').innerHTML = '';
                }
            } catch (err) {
                if (!silentRefresh) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('errorText').textContent = 'Errore nel caricamento. Verifica il codice fermata.';
                    document.getElementById('error').classList.remove('hidden');
                }
                console.error(err);
            }
        }
        
        // Auto-refresh functions
        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                searchStop(true);
            }, 15000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Show connections
        function showConnections(buses) {
            const lines = [...new Set(buses.map(b => b.line.toUpperCase()))];
            let connections = [];
            
            if (lines.some(l => ['V15', 'H6', '7', '33', '39'].includes(l))) {
                connections.push({ line: 'L3', class: 'metro-l3' });
            }
            if (lines.some(l => ['V13', 'H8', '6', '34'].includes(l))) {
                connections.push({ line: 'L1', class: 'metro-l1' });
            }
            if (lines.some(l => ['H12', 'V21', '47'].includes(l))) {
                connections.push({ line: 'L4', class: 'metro-l4' });
            }
            if (lines.some(l => ['D20', '24'].includes(l))) {
                connections.push({ line: 'L5', class: 'metro-l5' });
            }
            if (lines.some(l => ['T1', 'T2', 'T3'].includes(l))) {
                connections.push({ line: 'Tram', class: 'tram' });
            }
            
            if (connections.length > 0) {
                document.getElementById('connectionsList').innerHTML = connections.map(c => 
                    `<span class="connection-chip ${c.class}">${c.line}</span>`
                ).join('');
                document.getElementById('connections').classList.remove('hidden');
            }
        }
        
        // Favorites management
        function toggleFavorite() {
            if (!currentStop) return;
            
            const index = favorites.findIndex(f => f.code === currentStop.code);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(currentStop);
            }
            
            localStorage.setItem('tmbFavorites', JSON.stringify(favorites));
            updateFavoriteButton();
            renderQuickFavorites();
        }
        
        function updateFavoriteButton() {
            const btn = document.getElementById('favoriteBtn');
            const isFav = favorites.some(f => f.code === currentStop?.code);
            btn.textContent = isFav ? '‚òÖ' : '‚òÜ';
            btn.classList.toggle('active', isFav);
        }
        
        function renderQuickFavorites() {
            const container = document.getElementById('favoritesButtons');
            const wrapper = document.getElementById('quickFavorites');
            
            if (favorites.length === 0) {
                wrapper.classList.add('hidden');
                return;
            }
            
            wrapper.classList.remove('hidden');
            container.innerHTML = favorites.map(f => `
                <button onclick="quickSearch('${f.code}')" class="favorite-chip">
                    ${f.code} - ${f.name.substring(0, 12)}${f.name.length > 12 ? '...' : ''}
                </button>
            `).join('');
        }
        
        function quickSearch(code) {
            document.getElementById('stopCode').value = code;
            searchStop();
        }
        
        // Load all stops
        async function loadAllStops() {
            try {
                const data = await fetchWithProxy(`${BASE_URL}/transit/parades?app_id=${API_ID}&app_key=${API_KEY}`);
                
                if (data.features) {
                    allStops = data.features.map(f => ({
                        code: f.properties.CODI_PARADA || f.properties.CODI,
                        name: f.properties.NOM_PARADA || f.properties.NOM || 'Fermata',
                        lat: f.geometry.coordinates[1],
                        lon: f.geometry.coordinates[0]
                    })).filter(s => s.code);
                    
                    allStops.sort((a, b) => parseInt(a.code) - parseInt(b.code));
                }
            } catch (err) {
                console.error('Errore caricamento fermate:', err);
            }
        }
        
        // Render favorites list
        function renderFavoritesList() {
            const container = document.getElementById('myFavoritesList');
            
            if (favorites.length === 0) {
                container.innerHTML = '<p class="p-4 text-gray-500 text-center text-sm">Nessuna fermata preferita</p>';
                return;
            }
            
            container.innerHTML = favorites.map(f => `
                <div class="stop-item flex items-center justify-between">
                    <div class="flex-1 min-w-0" onclick="selectStopFromList('${f.code}')">
                        <span class="font-bold text-red-600">${f.code}</span>
                        <span class="text-gray-400 mx-1">‚Äî</span>
                        <span class="text-gray-700 text-sm">${f.name}</span>
                    </div>
                    <button onclick="removeFavorite('${f.code}')" class="text-gray-400 hover:text-red-500 text-lg px-2 transition-colors flex-shrink-0">‚úï</button>
                </div>
            `).join('');
        }
        
        function removeFavorite(code) {
            favorites = favorites.filter(f => f.code !== code);
            localStorage.setItem('tmbFavorites', JSON.stringify(favorites));
            renderFavoritesList();
            renderQuickFavorites();
        }
        
        // Render all stops
        function renderAllStops() {
            const container = document.getElementById('allStopsList');
            const search = document.getElementById('searchStops').value.toLowerCase();
            
            let filtered = allStops;
            if (search) {
                filtered = allStops.filter(s => 
                    s.code.toString().includes(search) || 
                    s.name.toLowerCase().includes(search)
                );
            }
            
            const toShow = filtered.slice(0, 100);
            
            container.innerHTML = toShow.map(s => {
                const isFav = favorites.some(f => f.code == s.code);
                return `
                    <div class="stop-item flex items-center justify-between">
                        <div class="flex-1 min-w-0" onclick="selectStopFromList('${s.code}')">
                            <span class="font-bold text-red-600">${s.code}</span>
                            <span class="text-gray-400 mx-1">‚Äî</span>
                            <span class="text-gray-700 text-sm">${s.name}</span>
                        </div>
                        <button onclick="addToFavorites('${s.code}', '${s.name.replace(/'/g, "\\'")}')" 
                                class="star-btn text-lg flex-shrink-0 ${isFav ? 'active' : ''}">
                            ${isFav ? '‚òÖ' : '‚òÜ'}
                        </button>
                    </div>
                `;
            }).join('');
            
            if (filtered.length > 100) {
                container.innerHTML += `<p class="p-3 text-center text-gray-400 text-xs">Mostrando 100 di ${filtered.length} fermate</p>`;
            }
            
            if (toShow.length === 0) {
                container.innerHTML = '<p class="p-4 text-gray-500 text-center text-sm">Nessuna fermata trovata</p>';
            }
        }
        
        function filterStops() {
            renderAllStops();
        }
        
        function addToFavorites(code, name) {
            const index = favorites.findIndex(f => f.code == code);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push({ code, name });
            }
            localStorage.setItem('tmbFavorites', JSON.stringify(favorites));
            renderFavoritesList();
            renderAllStops();
            renderQuickFavorites();
        }
        
        function selectStopFromList(code) {
            switchTab('cerca');
            document.getElementById('stopCode').value = code;
            searchStop();
        }
        
        // Geolocation functions
        function getMyLocation() {
            document.getElementById('nearbyInitial').classList.add('hidden');
            document.getElementById('locationError').classList.add('hidden');
            document.getElementById('nearbyStopsList').innerHTML = '';
            document.getElementById('locationLoading').classList.remove('hidden');
            
            if (!navigator.geolocation) {
                showLocationError('Il tuo browser non supporta la geolocalizzazione.');
                return;
            }
            
            const geoOptions = {
                enableHighAccuracy: false,
                timeout: 15000,
                maximumAge: 300000 
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    document.getElementById('locationLoading').classList.add('hidden');
                    showNearbyStops();
                },
                (error) => {
                    if (!geoOptions.enableHighAccuracy) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                userLocation = {
                                    lat: position.coords.latitude,
                                    lon: position.coords.longitude
                                };
                                document.getElementById('locationLoading').classList.add('hidden');
                                showNearbyStops();
                            },
                            (err) => handleGeoError(err),
                            { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                        );
                    } else {
                        handleGeoError(error);
                    }
                },
                geoOptions
            );
        }
        
        function handleGeoError(error) {
            let message = 'Errore nella geolocalizzazione.';
            switch(error.code) {
                case 1: message = 'Permesso negato. Abilita la posizione nel browser.'; break;
                case 2: message = 'Posizione non disponibile.'; break;
                case 3: message = 'Timeout nella ricerca.'; break;
            }
            showLocationError(message);
        }
        
        function showLocationError(message) {
            document.getElementById('locationLoading').classList.add('hidden');
            document.getElementById('locationErrorText').textContent = message;
            document.getElementById('locationError').classList.remove('hidden');
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function formatDistance(meters) {
            if (meters < 1000) {
                return `${Math.round(meters)} m`;
            }
            return `${(meters / 1000).toFixed(1)} km`;
        }
        
        function showNearbyStops() {
            if (!userLocation || allStops.length === 0) return;
            
            const stopsWithDistance = allStops
                .filter(s => s.lat && s.lon)
                .map(s => ({
                    ...s,
                    distance: calculateDistance(userLocation.lat, userLocation.lon, s.lat, s.lon)
                }))
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 15);
            
            const container = document.getElementById('nearbyStopsList');
            container.innerHTML = stopsWithDistance.map((s, index) => `
                <div class="nearby-stop fade-in" style="animation-delay: ${index * 0.05}s" onclick="selectStopFromList('${s.code}')">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-red-600">${s.code}</span>
                                <span class="distance-badge">${formatDistance(s.distance)}</span>
                            </div>
                            <p class="text-gray-700 text-sm truncate">${s.name}</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>
            `).join('');
        }
        
        // Map functions
        function initMap() {
            map = L.map('map').setView([41.3851, 2.1734], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            addStopMarkers();
        }
        
        function addStopMarkers() {
            const icon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="width:12px;height:12px;background:#dc0530;border:2px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            allStops.forEach(stop => {
                if (stop.lat && stop.lon) {
                    const marker = L.marker([stop.lat, stop.lon], { icon })
                        .addTo(map)
                        .bindTooltip(stop.name, { direction: 'top', offset: [0, -8] });
                    marker.on('click', () => selectStopOnMap(stop));
                    markers.push(marker);
                }
            });
        }
        
        function centerOnMyLocation() {
            const btn = document.getElementById('mapLocationBtn');
            btn.classList.add('active');
            
            if (!navigator.geolocation) {
                alert('Geolocalizzazione non supportata.');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    if (userMarker) map.removeLayer(userMarker);
                    
                    const userIcon = L.divIcon({
                        className: 'user-location-marker',
                        html: '<div class="user-marker-pulse"></div><div class="user-marker"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    userMarker = L.marker([userLocation.lat, userLocation.lon], { icon: userIcon })
                        .addTo(map)
                        .bindTooltip('La tua posizione', { direction: 'top', offset: [0, -10] });
                    
                    map.setView([userLocation.lat, userLocation.lon], 16);
                    btn.classList.remove('active');
                },
                () => { alert('Errore posizione'); btn.classList.remove('active'); }
            );
        }
        
        async function selectStopOnMap(stop) {
            selectedMapStop = stop;
            document.getElementById('mapStopName').textContent = stop.name;
            document.getElementById('mapStopCode').textContent = `Codice: ${stop.code}`;
            document.getElementById('mapStopInfo').classList.remove('hidden');
            try {
                const data = await fetchWithProxy(`${BASE_URL}/ibus/stops/${stop.code}?app_id=${API_ID}&app_key=${API_KEY}`);
                // (Existing logic to display map bus results)
                if (data.data && data.data.ibus && data.data.ibus.length > 0) {
                    let buses = data.data.ibus.filter(bus => !bus.line.toUpperCase().startsWith('N')).sort((a,b)=>a['t-in-min']-b['t-in-min']).slice(0,4);
                    document.getElementById('mapBusResults').innerHTML = buses.map(bus => `
                        <div class="card-bus rounded-lg p-2 flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <div class="bus-badge ${getLineClass(bus.line)}" style="min-width:45px;padding:6px 8px;font-size:0.9rem;">${bus.line}</div>
                                <span class="text-xs text-gray-600 truncate">${bus.destination || ''}</span>
                            </div>
                            <div class="flex-shrink-0">${formatArrival(bus['t-in-min'])}</div>
                        </div>`).join('');
                } else {
                    document.getElementById('mapBusResults').innerHTML = '<p class="text-gray-500 text-center py-2 text-sm">Nessun bus</p>';
                }
            } catch (e) {
                document.getElementById('mapBusResults').innerHTML = '<p class="text-red-500 text-center py-2 text-sm">Errore</p>';
            }
        }
        
        function viewStopFromMap() {
            if (selectedMapStop) { switchTab('cerca'); document.getElementById('stopCode').value = selectedMapStop.code; searchStop(); }
        }
        
        function showStopOnMap() {
            if (!currentStop) return;
            const stop = allStops.find(s => s.code == currentStop.code);
            if (!stop) return alert('No coordinate');
            switchTab('mappa');
            setTimeout(() => { map.setView([stop.lat, stop.lon], 19); selectStopOnMap(stop); }, 200);
        }

        // --- ROUTE PLANNER ---
        
        let routeState = { fromCoords: null, toCoords: null };
        let debounceTimer;
        let abortController = null; // Per cancellare richieste vecchie
        const suggestionCache = new Map(); // Cache semplice

        function handleAddressInput(input, listId) {
            clearTimeout(debounceTimer);
            const query = input.value.trim();
            const list = document.getElementById(listId);
            
            // Reset coords se l'utente modifica
            if (listId === 'fromList') routeState.fromCoords = null;
            if (listId === 'toList') routeState.toCoords = null;

            if (query.length < 3) { 
                list.style.display = 'none'; 
                return; 
            }

            // 1. RICERCA LOCALE IMMEDIATA (Fermate)
            // Filtra le fermate gi√† caricate in memoria (molto veloce)
            const localResults = searchLocalStops(query);
            renderMixedSuggestions(localResults, [], listId); // Mostra subito i risultati locali

            // 2. RICERCA REMOTA (Indirizzi) - Debounced
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query, listId, localResults);
            }, 500); // Aumentato a 500ms per ridurre carico
        }

        function searchLocalStops(query) {
            if (!allStops || allStops.length === 0) return [];
            const q = query.toLowerCase();
            return allStops
                .filter(s => s.name.toLowerCase().includes(q) || s.code.toString().startsWith(q))
                .slice(0, 3) // Prendi solo le prime 3
                .map(s => ({
                    type: 'stop',
                    display_name: `${s.name} (Fermata ${s.code})`,
                    lat: s.lat,
                    lon: s.lon,
                    code: s.code
                }));
        }

        async function fetchSuggestions(query, listId, localResults) {
            // Se c'√® una richiesta pendente (via controller), annullala logicamente
            if (abortController) {
                abortController.abort();
            }
            abortController = new AbortController();
            const currentSignal = abortController.signal;

            // Controllo Cache
            if (suggestionCache.has(query)) {
                renderMixedSuggestions(localResults, suggestionCache.get(query), listId);
                return;
            }
            
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=5&viewbox=2.0,41.2,2.3,41.5&bounded=1`;
            
            try {
                // Nota: fetchWithProxy non supporta signal nativo perch√© usa servizi esterni, 
                // ma controlliamo il segnale DOPO aver ricevuto la risposta.
                const data = await fetchWithProxy(url);
                
                if (currentSignal.aborted) return; // Ignora risultati vecchi se l'utente ha continuato a scrivere

                suggestionCache.set(query, data); // Salva in cache
                renderMixedSuggestions(localResults, data, listId);
                
            } catch (e) {
                if (!currentSignal.aborted) {
                    console.error("Autocomplete error", e);
                }
            }
        }

        function renderMixedSuggestions(localData, remoteData, listId) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            
            const combined = [...localData];
            
            // Aggiungi risultati remoti
            if (remoteData && remoteData.length > 0) {
                remoteData.forEach(item => {
                    combined.push({
                        type: 'address',
                        display_name: item.display_name,
                        lat: item.lat,
                        lon: item.lon
                    });
                });
            }

            if (combined.length === 0) {
                if (list.innerHTML === '') list.style.display = 'none';
                return;
            }

            combined.slice(0, 8).forEach(item => { // Max 8 risultati totali
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                
                // Icona diversa per fermata vs indirizzo
                const icon = item.type === 'stop' ? 'üöè' : 'üìç';
                
                // Semplifica nome indirizzo
                let displayName = item.display_name;
                if (item.type === 'address') {
                    displayName = item.display_name.split(',').slice(0, 3).join(',');
                }

                div.innerHTML = `<span class="mr-2">${icon}</span> ${displayName}`;
                
                div.onclick = () => {
                    const inputId = listId === 'fromList' ? 'routeFrom' : 'routeTo';
                    const input = document.getElementById(inputId);
                    input.value = displayName; // Usa il nome pulito
                    
                    // Store coordinates
                    if (listId === 'fromList') {
                        routeState.fromCoords = { lat: item.lat, lon: item.lon };
                    } else {
                        routeState.toCoords = { lat: item.lat, lon: item.lon };
                    }
                    
                    list.style.display = 'none';
                };
                list.appendChild(div);
            });
            
            list.style.display = 'block';
        }

        // Close lists on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container') && !e.target.closest('.suggestions-list') && !e.target.closest('.input-modern')) {
                document.querySelectorAll('.suggestions-list').forEach(l => l.style.display = 'none');
            }
        });

        function useMyLocationForRoute() {
            if (!navigator.geolocation) {
                alert("Geolocalizzazione non supportata");
                return;
            }
            const input = document.getElementById('routeFrom');
            input.value = "Sto cercando la posizione...";
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    routeState.fromCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    input.value = "La mia posizione";
                    input.classList.add("text-blue-600", "font-bold");
                },
                (err) => {
                    alert("Impossibile ottenere la posizione");
                    input.value = "";
                }
            );
        }

        async function calculateRoute() {
            const fromStr = document.getElementById('routeFrom').value;
            const toStr = document.getElementById('routeTo').value;
            const resultsDiv = document.getElementById('routeResults');
            const loader = document.getElementById('routeLoading');

            if (!fromStr || !toStr) {
                alert("Inserisci partenza e arrivo");
                return;
            }

            resultsDiv.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // If coords not set by autocomplete/GPS, try one last geocode (fallback)
                if (!routeState.fromCoords) {
                    // FIXED: Use fetchWithProxy for fallback geocoding
                    const data = await fetchWithProxy(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fromStr + ', Barcelona')}&format=json&limit=1`);
                    if(data[0]) routeState.fromCoords = { lat: data[0].lat, lon: data[0].lon };
                }
                if (!routeState.toCoords) {
                    // FIXED: Use fetchWithProxy for fallback geocoding
                    const data = await fetchWithProxy(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(toStr + ', Barcelona')}&format=json&limit=1`);
                    if(data[0]) routeState.toCoords = { lat: data[0].lat, lon: data[0].lon };
                }

                if (!routeState.fromCoords || !routeState.toCoords) {
                    throw new Error("Indirizzo non trovato. Usa i suggerimenti.");
                }

                // Call TMB Planner API via PROXY
                const date = new Date();
                const dateStr = `${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}-${date.getFullYear()}`;
                const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;

                const planUrl = `${BASE_URL}/planner/plan?fromPlace=${routeState.fromCoords.lat},${routeState.fromCoords.lon}&toPlace=${routeState.toCoords.lat},${routeState.toCoords.lon}&date=${dateStr}&time=${timeStr}&mode=BUS,WALK&app_id=${API_ID}&app_key=${API_KEY}`;
                
                const data = await fetchWithProxy(planUrl);
                
                loader.classList.add('hidden');

                if (data.plan && data.plan.itineraries && data.plan.itineraries.length > 0) {
                    
                    // FILTRO: Mantieni solo i percorsi che hanno almeno una tratta in BUS
                    const busItineraries = data.plan.itineraries.filter(it => 
                        it.legs.some(leg => leg.mode === 'BUS')
                    );

                    if (busItineraries.length === 0) {
                        resultsDiv.innerHTML = `
                            <div class="card-bus p-4 text-center">
                                <p class="text-orange-500 font-bold mb-1">Solo percorsi a piedi</p>
                                <p class="text-sm text-gray-500">Non sono stati trovati percorsi con autobus utili per questa tratta. Prova ad aumentare la distanza o cambiare destinazione.</p>
                            </div>`;
                        return;
                    }

                    // Limit to top 3
                    const topItineraries = busItineraries.slice(0, 3);
                    
                    topItineraries.forEach((itinerary, index) => {
                        const duration = Math.round(itinerary.duration / 60);
                        const startTime = new Date(itinerary.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const endTime = new Date(itinerary.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        let segmentsHtml = '';
                        let mapPolylines = [];

                        itinerary.legs.forEach(leg => {
                            // Collect geometry for map
                            if (leg.legGeometry && leg.legGeometry.points) {
                                let segColor = '#dc0530'; // Default Bus Red
                                let isCustomColor = false; // Flag per dare priorit√† al nostro colore

                                if (leg.mode === 'WALK') segColor = '#999';
                                else if (leg.mode === 'SUBWAY') segColor = '#0066b3'; // Metro default
                                
                                // Try to deduce color from line name if routeColor is missing
                                if (leg.mode === 'BUS') {
                                    const lName = (leg.routeShortName || leg.route || '').toUpperCase();
                                    if (lName.startsWith('V')) { segColor = '#00a651'; isCustomColor = true; } // Green
                                    else if (lName.startsWith('H')) { segColor = '#003888'; isCustomColor = true; } // Blue (Forced)
                                    else if (lName.startsWith('D')) { segColor = '#8e44ad'; isCustomColor = true; } // Purple
                                }
                                
                                // Usa il colore API solo se NON abbiamo settato un colore personalizzato specifico
                                const finalColor = (leg.routeColor && !isCustomColor) ? `#${leg.routeColor}` : segColor;

                                mapPolylines.push({
                                    points: leg.legGeometry.points,
                                    color: finalColor
                                });
                            }

                            if (leg.mode === 'WALK') {
                                segmentsHtml += `
                                    <div class="segment-detail">
                                        <div class="segment-line-left"></div>
                                        <div class="segment-dot-indicator" style="background:#fff;border-color:#ccc"></div>
                                        <div class="segment-header">
                                            <span class="segment-walk-info">üö∂ Cammina ${Math.round(leg.duration/60)} min</span>
                                        </div>
                                    </div>`;
                            } else if (leg.mode === 'BUS') {
                                // FIX: Prefer routeShortName (e.g. "V3") over route (which might be "Zona Franca...")
                                const lineNum = leg.routeShortName || leg.route;
                                const lineClass = getLineClass(lineNum);
                                
                                segmentsHtml += `
                                    <div class="segment-detail">
                                        <div class="segment-line-left"></div>
                                        <div class="segment-dot-indicator" style="background:#dc0530;border-color:#dc0530"></div>
                                        <div class="segment-bus-info">
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="bus-badge ${lineClass}" style="font-size:1rem;padding:6px 10px;min-width:45px">${lineNum}</div>
                                                <div class="text-xs text-gray-500 font-medium">Direz. ${leg.headsign}</div>
                                            </div>
                                            
                                            <div class="stop-detail-row">
                                                <div>
                                                    <div class="stop-label">Sali a</div>
                                                    <div class="stop-name">${leg.from.name}</div>
                                                </div>
                                                <div class="stop-code-pill">${leg.from.stopCode || ''}</div>
                                            </div>
                                            
                                            <div class="text-center my-1">
                                                <svg class="w-4 h-4 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                                            </div>

                                            <div class="stop-detail-row">
                                                <div>
                                                    <div class="stop-label">Scendi a</div>
                                                    <div class="stop-name">${leg.to.name}</div>
                                                </div>
                                                <div class="stop-code-pill">${leg.to.stopCode || ''}</div>
                                            </div>
                                        </div>
                                    </div>`;
                            }
                        });

                        const mapId = `map-route-${index}`;
                        
                        resultsDiv.innerHTML += `
                            <div class="route-card">
                                <div class="route-summary">
                                    <div class="route-time">${startTime} - ${endTime}</div>
                                    <div class="route-duration">${duration} min</div>
                                </div>
                                <div class="pl-2">
                                    ${segmentsHtml}
                                </div>
                                <div id="${mapId}" class="map-container-route"></div>
                            </div>
                        `;

                        // Initialize Map for this result
                        setTimeout(() => {
                            const rMap = L.map(mapId, { zoomControl: false, attributionControl: false });
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(rMap);
                            
                            let bounds = [];
                            mapPolylines.forEach(p => {
                                const latlngs = decodePolyline(p.points);
                                L.polyline(latlngs, { color: p.color, weight: 4 }).addTo(rMap);
                                bounds = bounds.concat(latlngs);
                            });
                            
                            if (bounds.length > 0) {
                                rMap.fitBounds(bounds, { padding: [20, 20] });
                            }
                        }, 500); // Delay to ensure DOM is ready
                    });

                } else {
                    resultsDiv.innerHTML = `
                        <div class="card-bus p-4 text-center">
                            <p class="text-orange-500 font-bold mb-1">Nessun percorso Bus trovato</p>
                            <p class="text-sm text-gray-500">Prova a cercare una distanza pi√π breve o verifica che ci siano fermate vicine.</p>
                        </div>`;
                }

            } catch (e) {
                console.error(e);
                loader.classList.add('hidden');
                resultsDiv.innerHTML = `
                    <div class="card-bus p-4 text-center">
                        <p class="text-red-500 font-bold mb-1">Errore percorso</p>
                        <p class="text-sm text-gray-500">${e.message || "Indirizzo non valido o servizio non disponibile."}</p>
                    </div>`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllStops();
            renderQuickFavorites();
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container') && !e.target.closest('.suggestions-list') && !e.target.closest('.input-modern')) {
                    document.querySelectorAll('.suggestions-list').forEach(l => l.style.display = 'none');
                }
            });
        });
    </script>
</body>
</html>
